<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR.IO x402 Upload - Turbo Bundler</title>
  <link rel="icon" type="image/png" id="favicon">
  <script>
    // Set favicon dynamically based on current gateway
    const faviconId = '65FaCJ0OeqioKDIbJ5VzmAx9obeKdYeJRq_fRHvJRFE';
    let currentHost = window.location.hostname || 'arweave.net';
    // Use arweave.net for localhost/local development
    if (currentHost === 'localhost' || currentHost === '127.0.0.1' || currentHost === '') {
      currentHost = 'arweave.net';
    }
    const protocol = window.location.protocol || 'https:';
    document.getElementById('favicon').href = `${protocol}//${currentHost}/${faviconId}`;
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@dha-team/arbundles@1.0.4/build/web/bundle.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --canvas: #171717;
      --surface: #1F1F1F;
      --default: #333;
      --fg-muted: #ededed;
      --link: #A3A3AD;
      --turbo-red: #FE0230;
      --turbo-green: #18A957;
      --turbo-blue: #3142C4;
      --turbo-yellow: #FFBB38;
    }

    body {
      font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px;
      background: var(--canvas);
      color: var(--fg-muted);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      background: var(--surface);
      padding: 40px;
      border-radius: 12px;
      border: 1px solid var(--default);
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    }

    h1 {
      color: var(--fg-muted);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 24px;
    }

    /* Mode Selector Tabs */
    .mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--default);
      padding-bottom: 0;
    }

    .mode-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--link);
      font-size: 1rem;
      font-weight: 500;
      font-family: 'Rubik', sans-serif;
      cursor: pointer;
      transition: color 150ms, border-color 150ms;
      margin-bottom: -1px;
    }

    .mode-tab:hover {
      color: var(--fg-muted);
      border-bottom-color: rgba(254, 2, 48, 0.3);
    }

    .mode-tab.active {
      color: var(--turbo-red);
      border-bottom-color: var(--turbo-red);
      font-weight: 700;
    }

    .badge {
      display: inline-block;
      background: var(--turbo-red);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      margin-left: 8px;
      vertical-align: middle;
    }

    /* Info sections with gradient */
    .info {
      background: linear-gradient(to bottom right, rgba(254, 2, 48, 0.05), rgba(254, 2, 48, 0.03));
      border: 1px solid rgba(254, 2, 48, 0.2);
      border-left: 4px solid var(--turbo-red);
      padding: 24px;
      margin: 24px 0;
      border-radius: 12px;
    }

    .info strong { color: var(--turbo-red); font-weight: 700; }
    .info p { margin: 8px 0; color: var(--fg-muted); font-size: 0.875rem; }
    .info ul { margin: 12px 0 0 20px; }
    .info li { margin: 6px 0; font-size: 0.875rem; }

    /* Service notice banner */
    .service-notice {
      background: linear-gradient(to bottom right, rgba(49, 66, 196, 0.08), rgba(49, 66, 196, 0.04));
      border: 1px solid rgba(49, 66, 196, 0.25);
      border-left: 4px solid var(--turbo-blue);
      padding: 16px 24px;
      margin: 20px 0;
      border-radius: 8px;
      font-size: 0.8125rem;
      line-height: 1.5;
    }

    .service-notice strong {
      color: var(--turbo-blue);
      font-weight: 600;
    }

    .service-notice .notice-text {
      color: var(--link);
      margin-top: 6px;
    }

    .service-notice .notice-highlight {
      color: var(--turbo-green);
      font-weight: 500;
    }

    /* Steps with gradient */
    .step {
      margin: 24px 0;
      padding: 24px;
      background: linear-gradient(to bottom right, rgba(254, 2, 48, 0.05), rgba(254, 2, 48, 0.03));
      border: 1px solid rgba(254, 2, 48, 0.2);
      border-radius: 12px;
    }

    .step h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: var(--fg-muted);
      font-size: 1.125rem;
      font-weight: 700;
    }

    .step p { margin: 8px 0; color: var(--link); font-size: 0.875rem; }

    /* Primary buttons - Turbo Red */
    button {
      background: var(--turbo-red);
      color: white;
      border: none;
      padding: 16px 24px;
      font-size: 1.125rem;
      font-weight: 700;
      font-family: 'Rubik', sans-serif;
      border-radius: 8px;
      cursor: pointer;
      margin: 12px 8px 12px 0;
      transition: background-color 150ms;
    }

    button:hover { background: rgba(254, 2, 48, 0.9); }
    button:active { background: #d40228; }
    button:disabled {
      background: #404144;
      color: #999;
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* Secondary buttons */
    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--default);
      color: var(--fg-muted);
      padding: 12px 20px;
      font-size: 0.875rem;
    }

    .btn-secondary:hover {
      background: var(--canvas);
    }

    .btn-danger {
      background: #8B5CF6 !important;
    }

    .btn-danger:hover {
      background: #7c3aed !important;
    }

    /* Config section */
    .config {
      background: linear-gradient(to bottom right, rgba(49, 66, 196, 0.05), rgba(49, 66, 196, 0.03));
      border: 1px solid rgba(49, 66, 196, 0.2);
      padding: 24px;
      border-radius: 12px;
      margin: 24px 0;
    }

    .config h3 {
      margin-top: 0;
      margin-bottom: 16px;
      color: var(--fg-muted);
      font-weight: 700;
    }

    .config label {
      display: block;
      margin: 12px 0;
      color: var(--fg-muted);
      font-weight: 500;
      font-size: 0.875rem;
    }

    /* Inputs */
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      background: var(--canvas);
      border: 1px solid var(--default);
      border-radius: 8px;
      color: var(--fg-muted);
      font-family: 'Rubik', sans-serif;
      font-size: 0.875rem;
      transition: border-color 150ms;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--turbo-red);
    }

    input::placeholder { color: #666; }

    /* Log console */
    .log {
      background: #0a0a0a;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--default);
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      margin: 20px 0;
    }

    .log-success { color: var(--turbo-green); }
    .log-error { color: var(--turbo-red); }
    .log-info { color: var(--turbo-blue); }
    .log-warning { color: var(--turbo-yellow); }

    /* Tag rows */
    .tag-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .tag-row input { margin: 0; }

    #walletInfo p,
    #fileInfo p {
      margin: 8px 0;
    }

    /* Hidden content */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ AR.IO x402 Upload</h1>

    <!-- Mode Selector -->
    <div class="mode-selector">
      <button class="mode-tab active" data-mode="raw" onclick="switchMode('raw')">
        Raw Upload <span class="badge">SIMPLEST</span>
      </button>
      <button class="mode-tab" data-mode="signed" onclick="switchMode('signed')">
        Signed Data Item <span class="badge">ADVANCED</span>
      </button>
    </div>

    <!-- Raw Upload Info -->
    <div id="info-raw" class="info">
      <strong>‚ú® Simplest x402 Upload</strong>
      <p>Upload raw files directly to Arweave with USDC payment.</p>
      <p><strong>No data item signing required!</strong> Just select a file and upload.</p>
      <ul>
        <li>Upload to server ‚Üí Get 402 Payment Required with exact price</li>
        <li>Sign USDC payment authorization in MetaMask</li>
        <li>Retry upload with payment ‚Üí Server accepts and creates data item</li>
        <li>Direct raw file upload (no ANS-104 wrapping needed)</li>
      </ul>
      <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(254, 2, 48, 0.3);"><strong>‚ö†Ô∏è Provenance Note:</strong> With raw upload, the data item is <strong>signed by the bundler</strong>, not your wallet. This means <strong>no cryptographic proof of authorship</strong> ‚Äî anyone could have uploaded this data. For verifiable provenance, use the <em>Signed Data Item</em> mode.</p>
      <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(49, 66, 196, 0.2); color: var(--link); font-size: 0.8125rem;"><strong style="color: var(--turbo-blue);">üìå Experimental Service:</strong> Data may take up to 30 minutes to propagate across the AR.IO network. However, your uploads are <span style="color: var(--turbo-green); font-weight: 500;">instantly cached and indexed with GraphQL</span> on the bundler's integrated AR.IO Gateway.</p>
    </div>

    <!-- Signed Data Item Info -->
    <div id="info-signed" class="info hidden">
      <strong>‚ú® Advanced x402 Upload</strong>
      <p>Create and sign your own ANS-104 data item before uploading to Arweave with USDC payment.</p>
      <p><strong>Full control over data item signing!</strong> You sign the data item with your MetaMask wallet.</p>
      <ul>
        <li>Create ANS-104 data item with custom tags and metadata</li>
        <li>Sign data item with your Ethereum wallet (MetaMask)</li>
        <li>Upload signed data item ‚Üí Get 402 Payment Required with exact price</li>
        <li>Sign USDC payment authorization in MetaMask</li>
        <li>Retry upload with payment ‚Üí Server accepts your signed data item</li>
        <li>Full ownership and control of the data item signature</li>
      </ul>
      <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(254, 2, 48, 0.3);"><strong>‚úÖ Provenance Guarantee:</strong> With signed data item upload, <strong>YOU sign the data item</strong> with your wallet before uploading. This provides <strong>cryptographic proof of authorship</strong> ‚Äî the data item is permanently linked to your wallet address, proving you created it. This is verifiable on-chain forever.</p>
      <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(49, 66, 196, 0.2); color: var(--link); font-size: 0.8125rem;"><strong style="color: var(--turbo-blue);">üìå Experimental Service:</strong> Data may take up to 30 minutes to propagate across the AR.IO network. However, your uploads are <span style="color: var(--turbo-green); font-weight: 500;">instantly cached and indexed with GraphQL</span> on the bundler's integrated AR.IO Gateway.</p>
    </div>

    <div class="config">
      <h3>‚öôÔ∏è Configuration</h3>
      <label>Upload Service URL:
        <input type="text" id="uploadUrl" value="https://upload.services.vilenarios.com">
      </label>
      <label>Network:
        <select id="network">
          <option value="base">Base Mainnet</option>
          <option value="base-sepolia">Base Sepolia (Testnet)</option>
        </select>
      </label>
    </div>

    <div class="step">
      <h3>Step 1: Connect Wallet</h3>
      <button id="connectBtn">Connect MetaMask</button>
      <button id="addUsdcBtn" class="btn-secondary" disabled>Add USDC to MetaMask</button>
      <div id="walletInfo"></div>
    </div>

    <div class="step">
      <h3>Step 2: Select File</h3>
      <input type="file" id="fileInput">
      <div id="fileInfo"></div>
    </div>

    <div class="step">
      <h3>Step 3: Custom Tags (Optional)</h3>
      <p>Add custom metadata tags to your upload</p>
      <div id="tagsContainer">
        <div class="tag-row">
          <input type="text" placeholder="Tag name" class="tag-name" style="width: 200px;">
          <input type="text" placeholder="Tag value" class="tag-value" style="width: 300px;">
        </div>
      </div>
      <button id="addTagBtn" class="btn-secondary">+ Add Another Tag</button>
    </div>

    <div class="step">
      <h3>Step 4: Upload</h3>
      <button id="uploadBtn" disabled>Upload with x402 Payment</button>
    </div>

    <!-- Upload Results -->
    <div id="uploadResults" class="hidden" style="margin: 24px 0; padding: 24px; background: linear-gradient(to bottom right, rgba(24, 169, 87, 0.1), rgba(24, 169, 87, 0.05)); border: 1px solid rgba(24, 169, 87, 0.3); border-left: 4px solid var(--turbo-green); border-radius: 12px;">
      <h3 style="color: var(--turbo-green); margin: 0 0 16px 0;">‚úÖ Upload Successful!</h3>
      <div style="background: var(--canvas); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
        <p style="font-size: 0.875rem; color: var(--link); margin-bottom: 8px;">Transaction ID:</p>
        <p id="resultId" style="font-family: monospace; font-size: 0.875rem; word-break: break-all; margin-bottom: 12px;"></p>
        <a id="resultLink" href="#" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--turbo-red); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; transition: background-color 150ms;">
          <span>View on Arweave</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </a>
      </div>
      <div id="resultDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; font-size: 0.875rem;"></div>
      <button onclick="resetUpload()" style="margin-top: 16px; background: var(--surface); border: 1px solid var(--default); color: var(--fg-muted); padding: 10px 20px; font-size: 0.875rem;">Upload Another File</button>
    </div>

    <h3 style="margin-top: 40px;">üìã Log</h3>
    <div class="log" id="log"></div>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--default); text-align: center; color: var(--link); font-size: 0.875rem;">
      Made with ‚ù§Ô∏è by <a href="https://x.com/vilenarios" target="_blank" style="color: var(--turbo-red); text-decoration: none; font-weight: 600; background: none; padding: 0; margin: 0; display: inline; border-radius: 0;">Vilenarios</a>
    </div>
  </div>

  <script>
    let provider;
    let signer;
    let userAddress;
    let selectedFile;
    let currentMode = 'raw'; // 'raw' or 'signed'
    let paidUsdcAmount = null; // Store USDC amount paid

    const NETWORK_CONFIG = {
      'base-sepolia': {
        chainId: 84532,
        usdcAddress: '0x036CbD53842c5426634e7929541eC2318f3dCF7e',
        name: 'Base Sepolia',
      },
      'base': {
        chainId: 8453,
        usdcAddress: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
        name: 'Base Mainnet',
      },
    };

    function switchMode(mode) {
      currentMode = mode;

      // Update tab styling
      document.querySelectorAll('.mode-tab').forEach(tab => {
        if (tab.dataset.mode === mode) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // Show/hide info sections
      if (mode === 'raw') {
        document.getElementById('info-raw').classList.remove('hidden');
        document.getElementById('info-signed').classList.add('hidden');
      } else {
        document.getElementById('info-raw').classList.add('hidden');
        document.getElementById('info-signed').classList.remove('hidden');
      }

      log(`Switched to ${mode === 'raw' ? 'Raw Upload' : 'Signed Data Item'} mode`, 'info');
    }

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    window.addEventListener('load', () => {
      log('Page loaded', 'info');
      if (!window.ethereum) {
        log('‚ùå MetaMask not detected! Access via http:// (not file://)', 'error');
        document.getElementById('connectBtn').textContent = 'MetaMask Not Found';
        document.getElementById('connectBtn').disabled = true;
      } else if (!window.ethereum.isMetaMask) {
        log('‚ö†Ô∏è Different wallet detected. Please use MetaMask for best compatibility.', 'warning');
      } else {
        log('‚úÖ MetaMask detected!', 'success');
      }
    });

    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        if (!window.ethereum) {
          alert('MetaMask not found!\\n\\n1. Install MetaMask from https://metamask.io\\n2. Access this page via http:// (not file://)');
          return;
        }

        log('Requesting MetaMask connection...', 'info');

        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];

        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();

        log(`‚úÖ Connected: ${userAddress}`, 'success');

        const networkKey = document.getElementById('network').value;
        const config = NETWORK_CONFIG[networkKey];
        const network = await provider.getNetwork();

        log(`Current network: chainId ${network.chainId}`, 'info');

        if (Number(network.chainId) !== config.chainId) {
          log(`‚ö†Ô∏è Please switch to ${config.name}`, 'warning');
          try {
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: `0x${config.chainId.toString(16)}` }],
            });
            log(`‚úÖ Switched to ${config.name}`, 'success');
          } catch (err) {
            log(`Failed to switch network: ${err.message}`, 'error');
          }
        }

        const usdcContract = new ethers.Contract(
          config.usdcAddress,
          ['function balanceOf(address) view returns (uint256)'],
          provider
        );
        const balance = await usdcContract.balanceOf(userAddress);
        const balanceFormatted = ethers.formatUnits(balance, 6);

        document.getElementById('walletInfo').innerHTML = `
          <p>‚úÖ Connected: ${userAddress}</p>
          <p>üåê Network: ${config.name}</p>
          <p>üíµ USDC Balance: ${balanceFormatted} USDC</p>
        `;

        log(`USDC Balance: ${balanceFormatted} USDC`, 'info');

        if (selectedFile) {
          document.getElementById('uploadBtn').disabled = false;
        }

        document.getElementById('addUsdcBtn').disabled = false;

      } catch (error) {
        log(`‚ùå Connection failed: ${error.message}`, 'error');
      }
    });

    document.getElementById('addUsdcBtn').addEventListener('click', async () => {
      try {
        const networkKey = document.getElementById('network').value;
        const config = NETWORK_CONFIG[networkKey];

        log(`Adding USDC token (${config.usdcAddress}) to MetaMask...`, 'info');

        await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: config.usdcAddress,
              symbol: 'USDC',
              decimals: 6,
              image: 'https://cryptologos.cc/logos/usd-coin-usdc-logo.png',
            },
          },
        });

        log('‚úÖ USDC token added to MetaMask! Check your assets.', 'success');
      } catch (error) {
        log(`‚ùå Failed to add token: ${error.message}`, 'error');
      }
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        log(`File selected: ${selectedFile.name} (${selectedFile.size} bytes)`, 'info');
        document.getElementById('fileInfo').innerHTML = `
          <p>üìÑ ${selectedFile.name}</p>
          <p>üìä Size: ${(selectedFile.size / 1024).toFixed(2)} KB</p>
        `;
        if (signer) {
          document.getElementById('uploadBtn').disabled = false;
        }
      }
    });

    document.getElementById('addTagBtn').addEventListener('click', () => {
      const container = document.getElementById('tagsContainer');
      const newRow = document.createElement('div');
      newRow.className = 'tag-row';
      newRow.style.marginTop = '10px';
      newRow.innerHTML = `
        <input type="text" placeholder="Tag name" class="tag-name" style="width: 200px;">
        <input type="text" placeholder="Tag value" class="tag-value" style="width: 300px;">
        <button onclick="this.parentElement.remove()" class="btn-danger" style="padding: 8px 12px; font-size: 14px;">Remove</button>
      `;
      container.appendChild(newRow);
    });

    // MetaMask signer for arbundles (used in signed mode)
    class MetaMaskSigner {
      constructor(ethersSigner, address) {
        this.signer = ethersSigner;
        this.address = address;
        this.signatureType = 3;
        this.signatureLength = 65;
        this.ownerLength = 65;
        this.publicKey = null;
      }

      async setPublicKey() {
        if (!this.publicKey) {
          const message = 'Derive public key for Arbundles';
          const signature = await this.signer.signMessage(message);
          const messageHash = ethers.hashMessage(message);
          const recoveredPublicKey = ethers.SigningKey.recoverPublicKey(messageHash, signature);
          const publicKeyHex = recoveredPublicKey.slice(2);
          const bytes = new Uint8Array(publicKeyHex.length / 2);
          for (let i = 0; i < publicKeyHex.length; i += 2) {
            bytes[i / 2] = parseInt(publicKeyHex.substr(i, 2), 16);
          }
          this.publicKey = bytes;
          log(`Public key derived: ${this.publicKey.length} bytes`, 'info');
        }
      }

      async sign(message) {
        await this.setPublicKey();
        const signature = await this.signer.signMessage(message);
        return new Uint8Array(ethers.getBytes(signature));
      }
    }

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!selectedFile || !signer) {
        log('Please connect wallet and select a file', 'error');
        return;
      }

      document.getElementById('uploadBtn').disabled = true;

      try {
        const uploadUrl = document.getElementById('uploadUrl').value;

        // Read file
        log('Reading file...', 'info');
        const fileBuffer = await selectedFile.arrayBuffer();
        const fileData = new Uint8Array(fileBuffer);
        log(`File read: ${fileData.length} bytes`, 'info');

        // Prepare data to upload
        let uploadData;
        let contentType;
        let customHeaders = {};

        if (currentMode === 'raw') {
          // RAW UPLOAD MODE
          log('Mode: Raw Upload - server will sign data item', 'info');
          uploadData = fileData;
          contentType = selectedFile.type || 'application/octet-stream';

          // Collect custom tags as headers
          const tagRows = document.querySelectorAll('.tag-row');
          let customTagCount = 0;
          tagRows.forEach(row => {
            const nameInput = row.querySelector('.tag-name');
            const valueInput = row.querySelector('.tag-value');
            if (nameInput && valueInput && nameInput.value.trim() && valueInput.value.trim()) {
              const headerName = `X-Tag-${nameInput.value.trim().replace(/\\s+/g, '-')}`;
              customHeaders[headerName] = valueInput.value.trim();
              log(`Will add tag: ${nameInput.value.trim()} = ${valueInput.value.trim()}`, 'info');
              customTagCount++;
            }
          });
          if (customTagCount > 0) {
            log(`‚úÖ ${customTagCount} custom tag(s) will be included`, 'success');
          }
        } else {
          // SIGNED DATA ITEM MODE
          log('Mode: Signed Data Item - you sign with your wallet', 'info');
          log('Creating ANS-104 data item...', 'info');

          const dataSigner = new MetaMaskSigner(signer, userAddress);
          await dataSigner.setPublicKey();

          const tags = [
            { name: 'Content-Type', value: selectedFile.type || 'application/octet-stream' },
            { name: 'File-Name', value: selectedFile.name }
          ];

          // Add custom tags
          const tagRows = document.querySelectorAll('.tag-row');
          let customTagCount = 0;
          tagRows.forEach(row => {
            const nameInput = row.querySelector('.tag-name');
            const valueInput = row.querySelector('.tag-value');
            if (nameInput && valueInput && nameInput.value.trim() && valueInput.value.trim()) {
              tags.push({ name: nameInput.value.trim(), value: valueInput.value.trim() });
              log(`Added tag: ${nameInput.value.trim()} = ${valueInput.value.trim()}`, 'info');
              customTagCount++;
            }
          });
          if (customTagCount > 0) {
            log(`‚úÖ Added ${customTagCount} custom tag(s)`, 'success');
          }

          const dataItem = window.arbundles.createData(fileData, dataSigner, { tags });

          log('Signing data item (approve in MetaMask)...', 'info');
          await dataItem.sign(dataSigner);

          uploadData = dataItem.getRaw();
          contentType = 'application/octet-stream';
          log(`‚úÖ Data item signed! ID: ${await dataItem.id}`, 'success');
        }

        // Try upload first
        log('Attempting upload...', 'info');
        let uploadResponse = await fetch(`${uploadUrl}/v1/tx`, {
          method: 'POST',
          headers: {
            'Content-Type': contentType,
            'Content-Length': uploadData.length.toString(),
            ...customHeaders,
          },
          body: uploadData
        });

        let result;

        // Handle success with existing credit balance (200 OK)
        if (uploadResponse.status === 200) {
          log('‚úÖ Upload succeeded using existing credit balance!', 'success');
          log('‚ÑπÔ∏è Your wallet has credits - no x402 payment was required', 'info');
          result = await uploadResponse.json();
          paidUsdcAmount = null; // No payment made
        }
        // Handle x402 payment required (402)
        else if (uploadResponse.status === 402) {
          log('üí≥ 402 Payment Required - wallet has no credits, x402 payment needed', 'warning');
          const priceData = await uploadResponse.json();
          log('‚úÖ Received price quote from server', 'success');
          log(`Quote details: ${JSON.stringify(priceData, null, 2)}`, 'info');

          // Create payment authorization
          const networkKey = document.getElementById('network').value;
          const config = NETWORK_CONFIG[networkKey];
          const requirements = priceData.accepts.find(a => a.network === networkKey);

          if (!requirements) {
            throw new Error(`Network ${networkKey} not available`);
          }

          const baseAmount = BigInt(requirements.maxAmountRequired);
          const bufferedAmount = (baseAmount * BigInt(101)) / BigInt(100);
          const amount = ethers.formatUnits(bufferedAmount, 6);
          paidUsdcAmount = amount; // Store for results display
          log(`üí∞ Payment required: ${amount} USDC (base: ${ethers.formatUnits(baseAmount, 6)} + 1% buffer)`, 'warning');

          const currentTime = Math.floor(Date.now() / 1000);
          const validAfter = currentTime - 3600;
          const timeoutSeconds = requirements.maxTimeoutSeconds || 3600;
          const bufferSeconds = 120;
          const validBefore = currentTime + timeoutSeconds + bufferSeconds;

          log(`Payment window: ${validAfter} to ${validBefore} (timeout: ${timeoutSeconds}s + buffer: ${bufferSeconds}s)`, 'info');

          const nonce = ethers.hexlify(ethers.randomBytes(32));

          const authorization = {
            from: userAddress,
            to: requirements.payTo,
            value: bufferedAmount.toString(),
            validAfter,
            validBefore,
            nonce,
          };

          const domain = {
            name: 'USD Coin',
            version: '2',
            chainId: config.chainId,
            verifyingContract: config.usdcAddress,
          };

          const types = {
            TransferWithAuthorization: [
              { name: 'from', type: 'address' },
              { name: 'to', type: 'address' },
              { name: 'value', type: 'uint256' },
              { name: 'validAfter', type: 'uint256' },
              { name: 'validBefore', type: 'uint256' },
              { name: 'nonce', type: 'bytes32' },
            ],
          };

          log('Signing payment authorization (approve in MetaMask)...', 'warning');
          const signature = await signer.signTypedData(domain, types, authorization);
          log('‚úÖ Payment authorized!', 'success');

          const paymentPayload = {
            x402Version: 1,
            scheme: 'exact',
            network: networkKey,
            payload: { signature, authorization },
          };

          const paymentHeader = btoa(JSON.stringify(paymentPayload));

          // Retry upload with payment
          log('Retrying upload with payment...', 'info');
          uploadResponse = await fetch(`${uploadUrl}/v1/tx`, {
            method: 'POST',
            headers: {
              'Content-Type': contentType,
              'Content-Length': uploadData.length.toString(),
              'X-PAYMENT': paymentHeader,
              ...customHeaders,
            },
            body: uploadData
          });

          if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            throw new Error(`Upload failed: ${uploadResponse.status} - ${errorText}`);
          }

          result = await uploadResponse.json();
        }
        // Handle unexpected status
        else {
          const errorText = await uploadResponse.text();
          throw new Error(`Unexpected response: ${uploadResponse.status} - ${errorText}`);
        }
        log('üéâ Upload successful!', 'success');
        log(`üìÑ Data Item ID: ${result.id}`, 'success');

        // Use dataCaches from response to generate dynamic gateway link
        let gatewayHost = 'arweave.net';
        if (result.dataCaches && result.dataCaches.length > 0) {
          const currentHost = window.location.hostname;
          const matchingCache = result.dataCaches.find(cache => cache === currentHost);
          gatewayHost = matchingCache || result.dataCaches[0];
        }

        const txUrl = `https://${gatewayHost}/${result.id}`;
        log(`üîó View transaction: ${txUrl}`, 'success');
        log(`üë§ Owner: ${result.owner}`, 'info');
        log(`üí∞ Payer: ${result.payer}`, 'info');

        // Display results prominently
        document.getElementById('resultId').textContent = result.id;
        document.getElementById('resultLink').href = txUrl;

        let detailsHtml = `
          <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
            <strong style="color: var(--link); display: block; margin-bottom: 6px;">Owner:</strong>
            <span style="font-family: monospace; font-size: 0.75rem; color: var(--fg-muted); word-break: break-all;">${result.owner}</span>
          </div>
          <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
            <strong style="color: var(--link); display: block; margin-bottom: 6px;">Payer:</strong>
            <span style="font-family: monospace; font-size: 0.75rem; color: var(--fg-muted); word-break: break-all;">${result.payer}</span>
          </div>
        `;

        if (result.receipt) {
          log(`‚è±Ô∏è Timestamp: ${new Date(result.receipt.timestamp).toLocaleString()}`, 'info');
          log(`üíé Cost: ${result.receipt.winc} Winston`, 'info');
          log(`üìä Deadline Height: ${result.receipt.deadlineHeight}`, 'info');

          detailsHtml += `
            <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
              <strong style="color: var(--link); display: block; margin-bottom: 6px;">Storage Cost:</strong>
              <span style="color: var(--fg-muted);">${result.receipt.winc} Winston</span>
            </div>
          `;
        }

        // Display USDC cost or credit usage
        if (paidUsdcAmount) {
          detailsHtml += `
            <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
              <strong style="color: var(--link); display: block; margin-bottom: 6px;">USDC Paid:</strong>
              <span style="color: var(--turbo-green); font-weight: 700;">${paidUsdcAmount} USDC</span>
            </div>
          `;
        } else {
          detailsHtml += `
            <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
              <strong style="color: var(--link); display: block; margin-bottom: 6px;">Payment Method:</strong>
              <span style="color: var(--turbo-green); font-weight: 700;">Existing Credits</span>
            </div>
          `;
        }

        if (result.receipt) {
          detailsHtml += `
            <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
              <strong style="color: var(--link); display: block; margin-bottom: 6px;">Timestamp:</strong>
              <span style="color: var(--fg-muted);">${new Date(result.receipt.timestamp).toLocaleString()}</span>
            </div>
          `;
        }

        if (result.x402Payment) {
          log(`üí≥ Payment TX: ${result.x402Payment.transactionHash}`, 'success');
          log(`üåê Network: ${result.x402Payment.network}`, 'info');
          log(`üîÑ Mode: ${result.x402Payment.mode}`, 'info');
          log(`üÜî Payment ID: ${result.x402Payment.paymentId}`, 'info');

          detailsHtml += `
            <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
              <strong style="color: var(--link); display: block; margin-bottom: 6px;">Payment Network:</strong>
              <span style="color: var(--fg-muted);">${result.x402Payment.network}</span>
            </div>
            <div style="padding: 12px; background: var(--surface); border-radius: 8px;">
              <strong style="color: var(--link); display: block; margin-bottom: 6px;">Payment Mode:</strong>
              <span style="color: var(--fg-muted);">${result.x402Payment.mode}</span>
            </div>
          `;
        }

        document.getElementById('resultDetails').innerHTML = detailsHtml;
        document.getElementById('uploadResults').classList.remove('hidden');

        // Scroll to results
        document.getElementById('uploadResults').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      } catch (error) {
        log(`‚ùå Upload failed: ${error.message}`, 'error');
        console.error(error);
      } finally {
        document.getElementById('uploadBtn').disabled = false;
      }
    });

    function resetUpload() {
      document.getElementById('uploadResults').classList.add('hidden');
      document.getElementById('fileInput').value = '';
      document.getElementById('fileInfo').innerHTML = '';
      selectedFile = null;
      document.getElementById('uploadBtn').disabled = true;
      log('Ready for new upload', 'info');
    }
  </script>
</body>
</html>
