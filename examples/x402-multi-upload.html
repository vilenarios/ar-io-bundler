<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR.IO x402 Multi-Upload - Turbo Bundler</title>
  <link rel="icon" type="image/png" id="favicon">
  <script>
    // Set favicon dynamically based on current gateway
    const faviconId = '65FaCJ0OeqioKDIbJ5VzmAx9obeKdYeJRq_fRHvJRFE';
    let currentHost = window.location.hostname || 'arweave.net';
    // Use arweave.net for localhost/local development
    if (currentHost === 'localhost' || currentHost === '127.0.0.1' || currentHost === '') {
      currentHost = 'arweave.net';
    }
    const protocol = window.location.protocol || 'https:';
    document.getElementById('favicon').href = `${protocol}//${currentHost}/${faviconId}`;
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@dha-team/arbundles@1.0.3/build/web/bundle.js"></script>
  <!-- Farcaster Mini App SDK for Base App integration -->
  <script src="https://unpkg.com/@anthropic-ai/sdk@latest/dist/index.global.js" onerror="console.log('Farcaster SDK not loaded - will use MetaMask')"></script>
  <script type="module">
    // Try to load Farcaster Mini App SDK dynamically
    try {
      const { sdk } = await import('https://esm.sh/@farcaster/miniapp-sdk@0.0.13');
      window.farcasterSdk = sdk;
      console.log('Farcaster SDK loaded');
    } catch (e) {
      console.log('Farcaster SDK not available - using MetaMask mode');
      window.farcasterSdk = null;
    }
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --canvas: #171717;
      --surface: #1F1F1F;
      --default: #333;
      --fg-muted: #ededed;
      --link: #A3A3AD;
      --turbo-red: #FE0230;
      --turbo-green: #18A957;
      --turbo-blue: #3142C4;
      --turbo-yellow: #FFBB38;
    }

    body {
      font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px;
      background: var(--canvas);
      color: var(--fg-muted);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      background: var(--surface);
      padding: 40px;
      border-radius: 12px;
      border: 1px solid var(--default);
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    }

    h1 {
      color: var(--fg-muted);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 24px;
    }

    /* Mode Selector Tabs */
    .mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--default);
      padding-bottom: 0;
    }

    .mode-tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--link);
      font-size: 1rem;
      font-weight: 500;
      font-family: 'Rubik', sans-serif;
      cursor: pointer;
      transition: color 150ms, border-color 150ms;
      margin-bottom: -1px;
    }

    .mode-tab:hover {
      color: var(--fg-muted);
      border-bottom-color: rgba(254, 2, 48, 0.3);
    }

    .mode-tab.active {
      color: var(--turbo-red);
      border-bottom-color: var(--turbo-red);
      font-weight: 700;
    }

    .badge {
      display: inline-block;
      background: var(--turbo-red);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      margin-left: 8px;
      vertical-align: middle;
    }

    /* Info sections with gradient */
    .info {
      background: linear-gradient(to bottom right, rgba(254, 2, 48, 0.05), rgba(254, 2, 48, 0.03));
      border: 1px solid rgba(254, 2, 48, 0.2);
      border-left: 4px solid var(--turbo-red);
      padding: 24px;
      margin: 24px 0;
      border-radius: 12px;
    }

    .info strong { color: var(--turbo-red); font-weight: 700; }
    .info p { margin: 8px 0; color: var(--fg-muted); font-size: 0.875rem; }
    .info ul { margin: 12px 0 0 20px; }
    .info li { margin: 6px 0; font-size: 0.875rem; }

    /* Service notice banner */
    .service-notice {
      background: linear-gradient(to bottom right, rgba(49, 66, 196, 0.08), rgba(49, 66, 196, 0.04));
      border: 1px solid rgba(49, 66, 196, 0.25);
      border-left: 4px solid var(--turbo-blue);
      padding: 16px 24px;
      margin: 20px 0;
      border-radius: 8px;
      font-size: 0.8125rem;
      line-height: 1.5;
    }

    .service-notice strong {
      color: var(--turbo-blue);
      font-weight: 600;
    }

    .service-notice .notice-text {
      color: var(--link);
      margin-top: 6px;
    }

    .service-notice .notice-highlight {
      color: var(--turbo-green);
      font-weight: 500;
    }

    /* Steps with gradient */
    .step {
      margin: 24px 0;
      padding: 24px;
      background: linear-gradient(to bottom right, rgba(254, 2, 48, 0.05), rgba(254, 2, 48, 0.03));
      border: 1px solid rgba(254, 2, 48, 0.2);
      border-radius: 12px;
    }

    .step h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: var(--fg-muted);
      font-size: 1.125rem;
      font-weight: 700;
    }

    .step p { margin: 8px 0; color: var(--link); font-size: 0.875rem; }

    /* Primary buttons - Turbo Red */
    button {
      background: var(--turbo-red);
      color: white;
      border: none;
      padding: 16px 24px;
      font-size: 1.125rem;
      font-weight: 700;
      font-family: 'Rubik', sans-serif;
      border-radius: 8px;
      cursor: pointer;
      margin: 12px 8px 12px 0;
      transition: background-color 150ms;
    }

    button:hover { background: rgba(254, 2, 48, 0.9); }
    button:active { background: #d40228; }
    button:disabled {
      background: #404144;
      color: #999;
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* Secondary buttons */
    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--default);
      color: var(--fg-muted);
      padding: 12px 20px;
      font-size: 0.875rem;
    }

    .btn-secondary:hover {
      background: var(--canvas);
    }

    .btn-danger {
      background: #8B5CF6 !important;
    }

    .btn-danger:hover {
      background: #7c3aed !important;
    }

    /* Config section */
    .config {
      background: linear-gradient(to bottom right, rgba(49, 66, 196, 0.05), rgba(49, 66, 196, 0.03));
      border: 1px solid rgba(49, 66, 196, 0.2);
      padding: 24px;
      border-radius: 12px;
      margin: 24px 0;
    }

    .config h3 {
      margin-top: 0;
      margin-bottom: 16px;
      color: var(--fg-muted);
      font-weight: 700;
    }

    .config label {
      display: block;
      margin: 12px 0;
      color: var(--fg-muted);
      font-weight: 500;
      font-size: 0.875rem;
    }

    /* Inputs */
    input[type="text"],
    input[type="file"],
    select {
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      background: var(--canvas);
      border: 1px solid var(--default);
      border-radius: 8px;
      color: var(--fg-muted);
      font-family: 'Rubik', sans-serif;
      font-size: 0.875rem;
      transition: border-color 150ms;
    }

    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--turbo-red);
    }

    input::placeholder { color: #666; }

    /* Log console */
    .log {
      background: #0a0a0a;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--default);
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      margin: 20px 0;
    }

    .log-success { color: var(--turbo-green); }
    .log-error { color: var(--turbo-red); }
    .log-info { color: var(--turbo-blue); }
    .log-warning { color: var(--turbo-yellow); }

    /* Tag rows */
    .tag-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .tag-row input { margin: 0; }

    #walletInfo p,
    #fileInfo p {
      margin: 8px 0;
    }

    /* Hidden content */
    .hidden {
      display: none !important;
    }

    /* File list styles */
    .file-list-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--canvas);
      border: 1px solid var(--default);
      border-radius: 8px;
      font-size: 0.875rem;
      flex-wrap: wrap;
    }

    .file-status-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .file-name {
      flex: 1;
      min-width: 150px;
      color: var(--fg-muted);
      word-break: break-word;
    }

    .file-size {
      color: var(--link);
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .file-remove-btn {
      padding: 4px 12px;
      background: rgba(254, 2, 48, 0.1);
      border: 1px solid var(--turbo-red);
      color: var(--turbo-red);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: background 150ms;
    }

    .file-remove-btn:hover {
      background: rgba(254, 2, 48, 0.2);
    }

    .file-remove-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(254, 2, 48, 0.05);
      border-color: rgba(254, 2, 48, 0.3);
    }

    .file-result-link {
      color: var(--turbo-green);
      text-decoration: none;
      font-weight: 600;
      font-family: monospace;
      font-size: 0.75rem;
    }

    .file-result-link:hover {
      text-decoration: underline;
    }

    .file-error {
      color: var(--turbo-red);
      font-size: 0.75rem;
      margin-left: 8px;
    }

    /* Status-specific styles */
    .file-status-pending { color: var(--link); }
    .file-status-uploading { color: var(--turbo-blue); }
    .file-status-success { color: var(--turbo-green); }
    .file-status-failed { color: var(--turbo-red); }

    /* Batch results */
    .batch-results {
      margin: 24px 0;
      padding: 24px;
      background: linear-gradient(to bottom right, rgba(24, 169, 87, 0.1), rgba(24, 169, 87, 0.05));
      border: 1px solid rgba(24, 169, 87, 0.3);
      border-left: 4px solid var(--turbo-green);
      border-radius: 12px;
    }

    .batch-results h3 {
      color: var(--fg-muted);
      margin: 0 0 16px 0;
    }

    .batch-summary {
      display: flex;
      gap: 24px;
      margin-bottom: 20px;
      font-size: 0.875rem;
    }

    .batch-summary-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* File details accordion */
    .file-payment-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .payment-usdc {
      background: rgba(24, 169, 87, 0.15);
      color: var(--turbo-green);
      border: 1px solid rgba(24, 169, 87, 0.3);
    }

    .payment-credits {
      background: rgba(49, 66, 196, 0.15);
      color: var(--turbo-blue);
      border: 1px solid rgba(49, 66, 196, 0.3);
    }

    .file-details-toggle {
      padding: 4px 12px;
      background: rgba(254, 2, 48, 0.1);
      border: 1px solid rgba(254, 2, 48, 0.3);
      color: var(--turbo-red);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 150ms;
      flex-shrink: 0;
      font-family: 'Rubik', sans-serif;
      margin: 0;
    }

    .file-details-toggle:hover {
      background: rgba(254, 2, 48, 0.2);
    }

    .file-details-panel {
      margin-top: 12px;
      padding: 16px;
      background: var(--canvas);
      border: 1px solid var(--default);
      border-radius: 8px;
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      font-size: 0.8125rem;
    }

    .file-details-panel.expanded {
      display: grid;
    }

    .file-detail-item {
      padding: 8px;
      background: var(--surface);
      border-radius: 6px;
    }

    .file-detail-label {
      color: var(--link);
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
      font-size: 0.75rem;
    }

    .file-detail-value {
      color: var(--fg-muted);
      font-family: monospace;
      font-size: 0.75rem;
      word-break: break-all;
    }

    .file-detail-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--turbo-red);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.75rem;
      transition: background-color 150ms;
      margin-top: 12px;
      display: block;
      width: fit-content;
    }

    .file-detail-link:hover {
      background: rgba(254, 2, 48, 0.9);
    }

    .file-detail-full {
      grid-column: 1 / -1;
    }

    /* Per-file tag editor */
    .file-tags-toggle {
      padding: 4px 12px;
      background: rgba(255, 187, 56, 0.1);
      border: 1px solid rgba(255, 187, 56, 0.3);
      color: var(--turbo-yellow);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 150ms;
      flex-shrink: 0;
      font-family: 'Rubik', sans-serif;
      margin: 0;
    }

    .file-tags-toggle:hover {
      background: rgba(255, 187, 56, 0.2);
    }

    .file-tags-panel {
      margin-top: 12px;
      padding: 16px;
      background: var(--canvas);
      border: 1px solid var(--default);
      border-radius: 8px;
      display: none;
    }

    .file-tags-panel.expanded {
      display: block;
    }

    .file-tag-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .file-tag-row input {
      margin: 0;
      padding: 8px;
      font-size: 0.8125rem;
    }

    .file-tag-name {
      width: 150px;
    }

    .file-tag-value {
      flex: 1;
      min-width: 200px;
    }

    .file-tag-remove {
      padding: 6px 10px;
      background: rgba(254, 2, 48, 0.1);
      border: 1px solid var(--turbo-red);
      color: var(--turbo-red);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: background 150ms;
      font-family: 'Rubik', sans-serif;
    }

    .file-tag-remove:hover {
      background: rgba(254, 2, 48, 0.2);
    }

    .file-tag-add {
      padding: 6px 12px;
      background: rgba(24, 169, 87, 0.1);
      border: 1px solid var(--turbo-green);
      color: var(--turbo-green);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: background 150ms;
      margin-top: 8px;
      font-family: 'Rubik', sans-serif;
    }

    .file-tag-add:hover {
      background: rgba(24, 169, 87, 0.2);
    }

    /* Tag header and labels */
    .file-tags-header {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--default);
    }

    .file-tags-title {
      display: block;
      color: var(--fg-muted);
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .file-tags-hint {
      display: block;
      color: var(--link);
      font-size: 0.75rem;
    }

    .file-tag-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .file-tag-label {
      color: var(--link);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* On desktop, hide labels and use inline layout */
    @media (min-width: 769px) {
      .file-tag-label {
        display: none;
      }

      .file-tag-field {
        flex-direction: row;
      }

      .file-tag-row {
        flex-direction: row;
        align-items: center;
      }

      .file-tag-field:first-child {
        width: 150px;
        flex-shrink: 0;
      }

      .file-tag-field:nth-child(2) {
        flex: 1;
        min-width: 200px;
      }
    }

    /* ==================== MOBILE RESPONSIVE STYLES ==================== */
    @media (max-width: 768px) {
      body {
        padding: 16px 12px;
      }

      .container {
        padding: 20px 16px;
        border-radius: 8px;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 16px;
      }

      /* Mode selector tabs - stack on mobile */
      .mode-selector {
        flex-direction: column;
        gap: 0;
      }

      .mode-tab {
        padding: 14px 16px;
        text-align: left;
        border-bottom: none;
        border-left: 3px solid transparent;
        margin-bottom: 0;
      }

      .mode-tab.active {
        border-bottom: none;
        border-left-color: var(--turbo-red);
        background: rgba(254, 2, 48, 0.05);
      }

      .badge {
        font-size: 10px;
        padding: 3px 8px;
      }

      /* Info sections */
      .info, .service-notice {
        padding: 16px;
        margin: 16px 0;
      }

      .info ul {
        margin-left: 16px;
      }

      /* Config section */
      .config {
        padding: 16px;
      }

      .config label {
        font-size: 0.8125rem;
      }

      /* Steps */
      .step {
        padding: 16px;
        margin: 16px 0;
      }

      .step h3 {
        font-size: 1rem;
      }

      /* Buttons - full width on mobile */
      button {
        width: 100%;
        padding: 14px 20px;
        font-size: 1rem;
        margin: 8px 0;
      }

      .btn-secondary {
        padding: 12px 16px;
      }

      /* File list - mobile optimized */
      .file-list-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        padding: 14px;
      }

      .file-list-item > * {
        width: 100%;
      }

      .file-status-icon {
        position: absolute;
        top: 14px;
        left: 14px;
      }

      .file-list-item {
        position: relative;
        padding-left: 48px;
      }

      .file-name {
        min-width: unset;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .file-size {
        font-size: 0.8rem;
      }

      /* File action buttons row */
      .file-actions-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      .file-remove-btn,
      .file-tags-toggle,
      .file-details-toggle {
        flex: 1;
        min-width: 80px;
        padding: 10px 12px;
        font-size: 0.8rem;
        text-align: center;
      }

      /* Payment badge */
      .file-payment-badge {
        display: block;
        text-align: center;
        padding: 8px 12px;
        font-size: 0.8rem;
        margin-bottom: 8px;
      }

      /* File details panel - mobile optimized */
      .file-details-panel {
        grid-template-columns: 1fr;
        padding: 12px;
        gap: 10px;
      }

      .file-details-panel.expanded {
        display: flex;
        flex-direction: column;
      }

      .file-detail-item {
        padding: 12px;
      }

      .file-detail-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }

      .file-detail-value {
        font-size: 0.8rem;
        line-height: 1.4;
      }

      .file-detail-link {
        width: 100%;
        justify-content: center;
        padding: 12px 16px;
        font-size: 0.875rem;
        margin-top: 8px;
      }

      /* Tags panel - mobile */
      .file-tags-panel {
        padding: 16px;
      }

      .file-tags-header {
        margin-bottom: 16px;
        padding-bottom: 12px;
      }

      .file-tags-title {
        font-size: 1rem;
      }

      .file-tags-hint {
        font-size: 0.8rem;
        margin-top: 4px;
      }

      .file-tag-row {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
        padding: 16px;
        background: var(--surface);
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .file-tag-field {
        width: 100%;
      }

      .file-tag-label {
        display: block !important;
        margin-bottom: 6px;
        font-size: 0.75rem;
      }

      .file-tag-row input {
        width: 100% !important;
        min-width: unset !important;
        max-width: 100% !important;
        box-sizing: border-box;
        padding: 14px 12px;
      }

      .file-tag-name,
      .file-tag-value {
        width: 100% !important;
        min-width: unset !important;
        flex: none;
      }

      .file-tag-remove {
        width: 100%;
        padding: 12px;
        margin-top: 4px;
      }

      .file-tag-add {
        width: 100%;
        padding: 14px;
        text-align: center;
        margin-top: 8px;
        font-size: 0.9rem;
      }

      /* Batch results - mobile */
      .batch-results {
        padding: 16px;
      }

      .batch-summary {
        flex-direction: column;
        gap: 12px;
      }

      /* Upload progress */
      #uploadProgress {
        padding: 0 4px;
      }

      #progressText {
        font-size: 0.8rem;
      }

      /* Log console - mobile */
      .log {
        font-size: 11px;
        padding: 12px;
        max-height: 300px;
      }

      /* Wallet info */
      #walletInfo p {
        font-size: 0.8rem;
        word-break: break-all;
      }

      /* Inputs */
      input[type="text"],
      input[type="file"],
      select {
        padding: 14px 12px;
        font-size: 16px; /* Prevents zoom on iOS */
      }
    }

    /* Extra small screens */
    @media (max-width: 400px) {
      .container {
        padding: 16px 12px;
      }

      h1 {
        font-size: 1.25rem;
      }

      .mode-tab {
        padding: 12px;
        font-size: 0.875rem;
      }

      .badge {
        display: none;
      }

      button {
        padding: 12px 16px;
        font-size: 0.9rem;
      }

      .file-detail-value {
        font-size: 0.7rem;
      }
    }

    /* ==================== MOBILE SUCCESS CARD ==================== */
    .mobile-success-card {
      background: linear-gradient(135deg, rgba(24, 169, 87, 0.15), rgba(24, 169, 87, 0.05));
      border: 1px solid rgba(24, 169, 87, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }

    .mobile-success-card .success-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .mobile-success-card .success-icon {
      font-size: 24px;
    }

    .mobile-success-card .success-title {
      color: var(--turbo-green);
      font-weight: 700;
      font-size: 1rem;
    }

    .mobile-success-card .tx-id-section {
      background: var(--canvas);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .mobile-success-card .tx-id-label {
      font-size: 0.7rem;
      color: var(--link);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .mobile-success-card .tx-id-value {
      font-family: monospace;
      font-size: 0.75rem;
      color: var(--fg-muted);
      word-break: break-all;
      line-height: 1.4;
    }

    .mobile-success-card .view-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px;
      background: var(--turbo-green);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.9rem;
      text-decoration: none;
      margin-bottom: 12px;
    }

    .mobile-success-card .view-btn:hover {
      background: #15924d;
    }

    .mobile-success-card .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .mobile-success-card .detail-box {
      background: var(--surface);
      border-radius: 6px;
      padding: 10px;
    }

    .mobile-success-card .detail-box.full-width {
      grid-column: 1 / -1;
    }

    .mobile-success-card .detail-label {
      font-size: 0.65rem;
      color: var(--link);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .mobile-success-card .detail-value {
      font-size: 0.8rem;
      color: var(--fg-muted);
      font-weight: 500;
      word-break: break-all;
    }

    .mobile-success-card .detail-value.highlight {
      color: var(--turbo-green);
    }

    /* ==================== MOBILE ERROR CARD ==================== */
    .mobile-error-card {
      background: linear-gradient(135deg, rgba(254, 2, 48, 0.15), rgba(254, 2, 48, 0.05));
      border: 1px solid rgba(254, 2, 48, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }

    .mobile-error-card .error-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .mobile-error-card .error-icon {
      font-size: 24px;
    }

    .mobile-error-card .error-title {
      color: var(--turbo-red);
      font-weight: 700;
      font-size: 1rem;
    }

    .mobile-error-card .error-message {
      background: var(--canvas);
      border-radius: 8px;
      padding: 12px;
      color: var(--fg-muted);
      font-size: 0.85rem;
      line-height: 1.5;
      word-break: break-word;
    }

    /* Mobile-specific details button improvements */
    @media (max-width: 768px) {
      .file-details-toggle {
        background: var(--turbo-green) !important;
        border-color: var(--turbo-green) !important;
        color: white !important;
        padding: 12px 16px !important;
        font-size: 0.9rem !important;
        margin-top: 8px;
      }

      .file-details-toggle:hover {
        background: #15924d !important;
      }

      /* When expanded, show a subtle style */
      .file-details-panel.expanded + .file-details-toggle,
      .file-details-toggle[style*="Hide"] {
        background: var(--surface) !important;
        border-color: var(--default) !important;
        color: var(--link) !important;
      }

      /* Ensure mobile success card fills width */
      .mobile-success-card {
        width: 100%;
      }

      /* File error on mobile - full width and clearer */
      .file-error {
        display: block;
        width: 100%;
        padding: 10px 12px;
        background: rgba(254, 2, 48, 0.1);
        border: 1px solid rgba(254, 2, 48, 0.3);
        border-radius: 8px;
        margin-top: 8px;
        font-size: 0.8rem;
        line-height: 1.4;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ AR.IO x402 Multi-Upload</h1>

    <!-- Mode Selector -->
    <div class="mode-selector">
      <button class="mode-tab active" data-mode="raw" onclick="switchMode('raw')">
        Raw Upload <span class="badge">SIMPLEST</span>
      </button>
      <button class="mode-tab" data-mode="signed" onclick="switchMode('signed')">
        Signed Data Item <span class="badge">ADVANCED</span>
      </button>
    </div>

    <!-- Raw Upload Info -->
    <div id="info-raw" class="info">
      <strong>‚ú® Simplest x402 Upload</strong>
      <p>Upload raw files directly to Arweave with USDC payment.</p>
      <p><strong>No data item signing required!</strong> Just select a file and upload.</p>
      <ul>
        <li>Upload to server ‚Üí Get 402 Payment Required with exact price</li>
        <li>Sign USDC payment authorization in MetaMask</li>
        <li>Retry upload with payment ‚Üí Server accepts and creates data item</li>
        <li>Direct raw file upload (no ANS-104 wrapping needed)</li>
      </ul>
      <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(254, 2, 48, 0.3);"><strong>‚ö†Ô∏è Provenance Note:</strong> With raw upload, the data item is <strong>signed by the bundler</strong>, not your wallet. This means <strong>no cryptographic proof of authorship</strong> ‚Äî anyone could have uploaded this data. For verifiable provenance, use the <em>Signed Data Item</em> mode.</p>
      <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(49, 66, 196, 0.2); color: var(--link); font-size: 0.8125rem;"><strong style="color: var(--turbo-blue);">üìå Experimental Service:</strong> Data may take up to 30 minutes to propagate across the AR.IO network. However, your uploads are <span style="color: var(--turbo-green); font-weight: 500;">instantly cached and indexed with GraphQL</span> on the bundler's integrated AR.IO Gateway.</p>
      <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 187, 56, 0.2); color: var(--link); font-size: 0.8125rem;"><strong style="color: var(--turbo-yellow);">üí≥ Multi-File Payment Model:</strong> Each file requires separate x402 payment (PAYG). If you have <span style="color: var(--turbo-green); font-weight: 500;">existing credits</span> in your account, files will use those automatically without payment signatures. You'll be prompted before upload starts.</p>
    </div>

    <!-- Signed Data Item Info -->
    <div id="info-signed" class="info hidden">
      <strong>‚ú® Advanced x402 Upload</strong>
      <p>Create and sign your own ANS-104 data item before uploading to Arweave with USDC payment.</p>
      <p><strong>Full control over data item signing!</strong> You sign the data item with your MetaMask wallet.</p>
      <ul>
        <li>Create ANS-104 data item with custom tags and metadata</li>
        <li>Sign data item with your Ethereum wallet (MetaMask)</li>
        <li>Upload signed data item ‚Üí Get 402 Payment Required with exact price</li>
        <li>Sign USDC payment authorization in MetaMask</li>
        <li>Retry upload with payment ‚Üí Server accepts your signed data item</li>
        <li>Full ownership and control of the data item signature</li>
      </ul>
      <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(254, 2, 48, 0.3);"><strong>‚úÖ Provenance Guarantee:</strong> With signed data item upload, <strong>YOU sign the data item</strong> with your wallet before uploading. This provides <strong>cryptographic proof of authorship</strong> ‚Äî the data item is permanently linked to your wallet address, proving you created it. This is verifiable on-chain forever.</p>
      <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(49, 66, 196, 0.2); color: var(--link); font-size: 0.8125rem;"><strong style="color: var(--turbo-blue);">üìå Experimental Service:</strong> Data may take up to 30 minutes to propagate across the AR.IO network. However, your uploads are <span style="color: var(--turbo-green); font-weight: 500;">instantly cached and indexed with GraphQL</span> on the bundler's integrated AR.IO Gateway.</p>
      <p style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 187, 56, 0.2); color: var(--link); font-size: 0.8125rem;"><strong style="color: var(--turbo-yellow);">üí≥ Multi-File Payment Model:</strong> Each file requires separate x402 payment (PAYG). If you have <span style="color: var(--turbo-green); font-weight: 500;">existing credits</span> in your account, files will use those automatically without payment signatures. You'll be prompted before upload starts.</p>
    </div>

    <div class="config">
      <h3>‚öôÔ∏è Configuration</h3>
      <label>Upload Service URL:
        <input type="text" id="uploadUrl" value="https://upload.services.vilenarios.com">
      </label>
      <label>Network:
        <select id="network">
          <option value="base">Base Mainnet</option>
          <option value="base-sepolia">Base Sepolia (Testnet)</option>
        </select>
      </label>
    </div>

    <div class="step">
      <h3>Step 1: Connect Wallet</h3>
      <button id="connectBtn">Connect MetaMask</button>
      <button id="addUsdcBtn" class="btn-secondary" disabled>Add USDC to MetaMask</button>
      <div id="walletInfo"></div>
    </div>

    <div class="step">
      <h3>Step 2: Select Files</h3>
      <input type="file" id="fileInput" multiple>
      <div id="fileInfo" style="margin-top: 12px; color: var(--link); font-size: 0.875rem;"></div>
      <div id="fileList" style="margin-top: 16px;"></div>
    </div>

    <div class="step">
      <h3>Step 3: Upload</h3>
      <button id="uploadBtn" disabled>Upload All Files with x402 Payment</button>
      <button id="cancelBtn" class="btn-secondary hidden" style="background: var(--canvas) !important; border: 1px solid var(--turbo-red) !important; color: var(--turbo-red) !important;">Cancel Batch</button>
      <div id="uploadProgress" class="hidden" style="margin-top: 16px;">
        <div id="progressText" style="color: var(--link); font-size: 0.875rem; margin-bottom: 8px;"></div>
        <div style="height: 8px; background: var(--canvas); border-radius: 4px; overflow: hidden; border: 1px solid var(--default);">
          <div id="progressBar" style="height: 100%; width: 0%; background: var(--turbo-red); transition: width 0.3s;"></div>
        </div>
      </div>
    </div>

    <!-- Upload Results -->
    <div id="uploadResults" class="hidden" style="margin: 24px 0; padding: 24px; background: linear-gradient(to bottom right, rgba(24, 169, 87, 0.1), rgba(24, 169, 87, 0.05)); border: 1px solid rgba(24, 169, 87, 0.3); border-left: 4px solid var(--turbo-green); border-radius: 12px;">
      <h3 style="color: var(--turbo-green); margin: 0 0 16px 0;">‚úÖ Upload Successful!</h3>
      <div style="background: var(--canvas); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
        <p style="font-size: 0.875rem; color: var(--link); margin-bottom: 8px;">Transaction ID:</p>
        <p id="resultId" style="font-family: monospace; font-size: 0.875rem; word-break: break-all; margin-bottom: 12px;"></p>
        <a id="resultLink" href="#" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--turbo-red); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; transition: background-color 150ms;">
          <span>View on Arweave</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
            <polyline points="15 3 21 3 21 9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </a>
      </div>
      <div id="resultDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; font-size: 0.875rem;"></div>
      <button onclick="resetUpload()" style="margin-top: 16px; background: var(--surface); border: 1px solid var(--default); color: var(--fg-muted); padding: 10px 20px; font-size: 0.875rem;">Upload Another File</button>
    </div>

    <h3 style="margin-top: 40px;">üìã Log</h3>
    <div class="log" id="log"></div>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--default); text-align: center; color: var(--link); font-size: 0.875rem;">
      Made with ‚ù§Ô∏è by <a href="https://x.com/vilenarios" target="_blank" style="color: var(--turbo-red); text-decoration: none; font-weight: 600; background: none; padding: 0; margin: 0; display: inline; border-radius: 0;">Vilenarios</a>
    </div>
  </div>

  <script>
    let provider;
    let signer;
    let userAddress;
    let selectedFiles = []; // Changed from selectedFile to selectedFiles array
    let currentMode = 'raw'; // 'raw' or 'signed'
    let cancelUpload = false; // Flag to cancel batch upload
    let uploadResults = []; // Store results for all files
    let dataSigner = null; // Reusable MetaMask signer for arbundles (signed mode)
    let fileTags = {}; // Store tags per file index: { 0: [{name, value}], 1: [...] }
    let isMiniApp = false; // Whether we're running inside Farcaster/Base Mini App
    let farcasterProvider = null; // Farcaster wallet provider

    // File upload limits
    const LIMITS = {
      maxFiles: 20,
      maxTotalSize: 200 * 1024 * 1024, // 200 MB
      maxFileSize: 50 * 1024 * 1024,   // 50 MB per file
    };

    const NETWORK_CONFIG = {
      'base-sepolia': {
        chainId: 84532,
        usdcAddress: '0x036CbD53842c5426634e7929541eC2318f3dCF7e',
        name: 'Base Sepolia',
      },
      'base': {
        chainId: 8453,
        usdcAddress: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',
        name: 'Base Mainnet',
      },
    };

    // Detect if we're in a Farcaster Mini App context
    async function detectMiniApp() {
      // Check for Farcaster SDK
      if (window.farcasterSdk) {
        try {
          const context = await window.farcasterSdk.context;
          if (context && context.user) {
            isMiniApp = true;
            log('üéØ Running inside Farcaster Mini App!', 'success');
            log(`User: ${context.user.displayName || context.user.username}`, 'info');

            // Get the Ethereum provider from Farcaster SDK
            farcasterProvider = await window.farcasterSdk.wallet.getEthereumProvider();

            // Disable signed mode - signMessage not supported in Mini App
            const signedTab = document.querySelector('[data-mode="signed"]');
            if (signedTab) {
              signedTab.disabled = true;
              signedTab.style.opacity = '0.5';
              signedTab.style.cursor = 'not-allowed';
              signedTab.title = 'Signed data items not supported in Mini App (signMessage unavailable)';
            }

            // Update connect button text
            document.getElementById('connectBtn').textContent = 'Connect Base Wallet';

            // Show Mini App notice
            showMiniAppNotice();

            return true;
          }
        } catch (e) {
          console.log('Not in Farcaster context:', e);
        }
      }

      // Also check for window.parent !== window (iframe detection)
      if (window.parent !== window) {
        log('‚ö†Ô∏è Running in iframe - may be Mini App context', 'warning');
      }

      return false;
    }

    // Show notice about Mini App limitations
    function showMiniAppNotice() {
      const notice = document.createElement('div');
      notice.className = 'service-notice';
      notice.innerHTML = `
        <strong>üéØ Mini App Mode Active</strong>
        <p class="notice-text">
          Running inside Base/Farcaster Mini App. <span class="notice-highlight">Signed data items are disabled</span>
          because message signing is not yet supported in Mini Apps.
        </p>
        <p class="notice-text" style="margin-top: 8px;">
          <strong>Payment Note:</strong> If you have <span class="notice-highlight">pre-purchased credits</span>,
          uploads will use those automatically. Otherwise, you'll need USDC for x402 payment
          (requires <code>signTypedData</code> which may not be supported yet).
        </p>
      `;

      const container = document.querySelector('.container');
      const modeSelector = document.querySelector('.mode-selector');
      container.insertBefore(notice, modeSelector);
    }

    async function switchMode(mode) {
      // Block signed mode in Mini App context
      if (mode === 'signed' && isMiniApp) {
        log('‚ùå Signed data items not available in Mini App (signMessage not supported)', 'error');
        alert('Signed data items are not available in Mini App mode because message signing (signMessage) is not yet supported by the Base wallet.');
        return;
      }

      currentMode = mode;

      // Update tab styling
      document.querySelectorAll('.mode-tab').forEach(tab => {
        if (tab.dataset.mode === mode) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      // Show/hide info sections
      if (mode === 'raw') {
        document.getElementById('info-raw').classList.remove('hidden');
        document.getElementById('info-signed').classList.add('hidden');
      } else {
        document.getElementById('info-raw').classList.add('hidden');
        document.getElementById('info-signed').classList.remove('hidden');

        // Initialize data signer if wallet already connected (only outside Mini App)
        if (signer && !dataSigner && !isMiniApp) {
          log('Initializing data signer for signed mode...', 'info');
          dataSigner = new MetaMaskSigner(signer, userAddress);
          await dataSigner.setPublicKey();
        }
      }

      log(`Switched to ${mode === 'raw' ? 'Raw Upload' : 'Signed Data Item'} mode`, 'info');
    }

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    window.addEventListener('load', async () => {
      log('Page loaded', 'info');

      // Wait a moment for Farcaster SDK to initialize
      await new Promise(resolve => setTimeout(resolve, 500));

      // Check if we're in Mini App context first
      const inMiniApp = await detectMiniApp();

      if (inMiniApp) {
        log('‚úÖ Farcaster wallet provider available', 'success');
        // Auto-connect in Mini App context
        document.getElementById('connectBtn').click();
      } else if (!window.ethereum) {
        log('‚ùå MetaMask not detected! Access via http:// (not file://)', 'error');
        document.getElementById('connectBtn').textContent = 'MetaMask Not Found';
        document.getElementById('connectBtn').disabled = true;
      } else if (!window.ethereum.isMetaMask) {
        log('‚ö†Ô∏è Different wallet detected. Please use MetaMask for best compatibility.', 'warning');
      } else {
        log('‚úÖ MetaMask detected!', 'success');
      }
    });

    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        // Determine which provider to use
        let ethProvider;
        if (isMiniApp && farcasterProvider) {
          ethProvider = farcasterProvider;
          log('Using Farcaster wallet provider...', 'info');
        } else if (window.ethereum) {
          ethProvider = window.ethereum;
          log('Requesting MetaMask connection...', 'info');
        } else {
          alert('No wallet found!\\n\\n1. If using MetaMask, install from https://metamask.io\\n2. If in Mini App, ensure wallet is connected');
          return;
        }

        const accounts = await ethProvider.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];

        provider = new ethers.BrowserProvider(ethProvider);
        signer = await provider.getSigner();

        log(`‚úÖ Connected: ${userAddress}`, 'success');

        const networkKey = document.getElementById('network').value;
        const config = NETWORK_CONFIG[networkKey];
        const network = await provider.getNetwork();

        log(`Current network: chainId ${network.chainId}`, 'info');

        if (Number(network.chainId) !== config.chainId) {
          log(`‚ö†Ô∏è Please switch to ${config.name}`, 'warning');
          try {
            await ethProvider.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: `0x${config.chainId.toString(16)}` }],
            });
            log(`‚úÖ Switched to ${config.name}`, 'success');
            // Refresh provider after network switch
            provider = new ethers.BrowserProvider(ethProvider);
            signer = await provider.getSigner();
          } catch (err) {
            log(`Failed to switch network: ${err.message}`, 'error');
          }
        }

        const usdcContract = new ethers.Contract(
          config.usdcAddress,
          ['function balanceOf(address) view returns (uint256)'],
          provider
        );
        const balance = await usdcContract.balanceOf(userAddress);
        const balanceFormatted = ethers.formatUnits(balance, 6);

        // Show wallet info with Mini App indicator if applicable
        const miniAppBadge = isMiniApp ? '<span style="background: var(--turbo-blue); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">Mini App</span>' : '';
        document.getElementById('walletInfo').innerHTML = `
          <p>‚úÖ Connected: ${userAddress}${miniAppBadge}</p>
          <p>üåê Network: ${config.name}</p>
          <p>üíµ USDC Balance: ${balanceFormatted} USDC</p>
        `;

        log(`USDC Balance: ${balanceFormatted} USDC`, 'info');

        // Initialize data signer for signed mode (only if NOT in Mini App)
        if (currentMode === 'signed' && !isMiniApp) {
          log('Initializing data signer for signed mode...', 'info');
          dataSigner = new MetaMaskSigner(signer, userAddress);
          await dataSigner.setPublicKey();
        } else if (currentMode === 'signed' && isMiniApp) {
          log('‚ö†Ô∏è Signed mode not available in Mini App - using raw mode', 'warning');
          switchMode('raw');
        }

        if (selectedFiles.length > 0) {
          document.getElementById('uploadBtn').disabled = false;
        }

        document.getElementById('addUsdcBtn').disabled = false;

      } catch (error) {
        log(`‚ùå Connection failed: ${error.message}`, 'error');
      }
    });

    document.getElementById('addUsdcBtn').addEventListener('click', async () => {
      try {
        const networkKey = document.getElementById('network').value;
        const config = NETWORK_CONFIG[networkKey];

        log(`Adding USDC token (${config.usdcAddress}) to MetaMask...`, 'info');

        await window.ethereum.request({
          method: 'wallet_watchAsset',
          params: {
            type: 'ERC20',
            options: {
              address: config.usdcAddress,
              symbol: 'USDC',
              decimals: 6,
              image: 'https://cryptologos.cc/logos/usd-coin-usdc-logo.png',
            },
          },
        });

        log('‚úÖ USDC token added to MetaMask! Check your assets.', 'success');
      } catch (error) {
        log(`‚ùå Failed to add token: ${error.message}`, 'error');
      }
    });

    // Helper function to format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    // Helper function to remove file from list
    function removeFile(index) {
      selectedFiles.splice(index, 1);

      // Rebuild fileTags object with new indices
      const oldTags = { ...fileTags };
      fileTags = {};
      Object.keys(oldTags).forEach(key => {
        const idx = parseInt(key);
        if (idx < index) {
          fileTags[idx] = oldTags[idx];
        } else if (idx > index) {
          fileTags[idx - 1] = oldTags[idx];
        }
        // Skip the removed index
      });

      displayFileList();
      if (selectedFiles.length === 0) {
        document.getElementById('uploadBtn').disabled = true;
      }
    }

    // Display file list with status indicators
    function displayFileList() {
      const fileListDiv = document.getElementById('fileList');
      const fileInfoDiv = document.getElementById('fileInfo');

      if (selectedFiles.length === 0) {
        fileListDiv.innerHTML = '';
        fileInfoDiv.innerHTML = '';
        return;
      }

      const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
      fileInfoDiv.innerHTML = `üì¶ ${selectedFiles.length} file(s) selected | Total size: ${formatFileSize(totalSize)}`;

      fileListDiv.innerHTML = selectedFiles.map((file, index) => {
        // Initialize tags for this file if not exists
        if (!fileTags[index]) {
          fileTags[index] = [];
        }

        return `
          <div style="margin-bottom: 16px;">
            <div class="file-list-item" id="file-item-${index}">
              <div class="file-status-icon file-status-pending" id="file-status-${index}">‚è≥</div>
              <div class="file-name" id="file-name-${index}">${file.name}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
              <div id="file-payment-${index}"></div>
              <button class="file-tags-toggle" id="file-tags-toggle-${index}" onclick="toggleFileTags(${index})">üè∑Ô∏è Tags</button>
              <button class="file-remove-btn" id="file-remove-${index}" onclick="removeFile(${index})">Remove</button>
              <button class="file-details-toggle hidden" id="file-toggle-${index}" onclick="toggleFileDetails(${index})">‚ñº Details</button>
            </div>
            <div class="file-tags-panel" id="file-tags-${index}">
              <div class="file-tags-header">
                <span class="file-tags-title">Custom Tags</span>
                <span class="file-tags-hint">Add metadata tags to this file</span>
              </div>
              <div id="file-tags-container-${index}">
                <div class="file-tag-row">
                  <div class="file-tag-field">
                    <label class="file-tag-label">Tag Name</label>
                    <input type="text" placeholder="e.g. Author" class="file-tag-name" data-file="${index}" data-tag="0">
                  </div>
                  <div class="file-tag-field">
                    <label class="file-tag-label">Tag Value</label>
                    <input type="text" placeholder="e.g. John Doe" class="file-tag-value" data-file="${index}" data-tag="0">
                  </div>
                </div>
              </div>
              <button class="file-tag-add" onclick="addFileTag(${index})">+ Add Another Tag</button>
            </div>
            <div class="file-details-panel" id="file-details-${index}"></div>
          </div>
        `;
      }).join('');
    }

    // Disable all remove buttons during upload
    function disableRemoveButtons() {
      selectedFiles.forEach((_, index) => {
        const btn = document.getElementById(`file-remove-${index}`);
        if (btn) btn.disabled = true;
      });
    }

    // Enable all remove buttons after upload
    function enableRemoveButtons() {
      selectedFiles.forEach((_, index) => {
        const btn = document.getElementById(`file-remove-${index}`);
        if (btn) btn.disabled = false;
      });
    }

    // Toggle file details panel
    function toggleFileDetails(index) {
      const panel = document.getElementById(`file-details-${index}`);
      const toggle = document.getElementById(`file-toggle-${index}`);

      if (panel.classList.contains('expanded')) {
        panel.classList.remove('expanded');
        toggle.textContent = '‚ñº Details';
      } else {
        panel.classList.add('expanded');
        toggle.textContent = '‚ñ≤ Hide';
      }
    }

    // Toggle file tags panel
    function toggleFileTags(index) {
      const panel = document.getElementById(`file-tags-${index}`);
      const toggle = document.getElementById(`file-tags-toggle-${index}`);

      if (panel.classList.contains('expanded')) {
        panel.classList.remove('expanded');
        toggle.textContent = 'üè∑Ô∏è Tags';
      } else {
        panel.classList.add('expanded');
        toggle.textContent = 'üè∑Ô∏è Hide';
      }
    }

    // Add a tag row for a specific file
    function addFileTag(fileIndex) {
      const container = document.getElementById(`file-tags-container-${fileIndex}`);
      const tagIndex = container.children.length;

      const newRow = document.createElement('div');
      newRow.className = 'file-tag-row';
      newRow.innerHTML = `
        <div class="file-tag-field">
          <label class="file-tag-label">Tag Name</label>
          <input type="text" placeholder="e.g. Category" class="file-tag-name" data-file="${fileIndex}" data-tag="${tagIndex}">
        </div>
        <div class="file-tag-field">
          <label class="file-tag-label">Tag Value</label>
          <input type="text" placeholder="e.g. Documents" class="file-tag-value" data-file="${fileIndex}" data-tag="${tagIndex}">
        </div>
        <button class="file-tag-remove" onclick="removeFileTag(this)">Remove Tag</button>
      `;
      container.appendChild(newRow);
    }

    // Remove a tag row
    function removeFileTag(button) {
      button.parentElement.remove();
    }

    // Get tags for a specific file from the UI
    function getFileTags(fileIndex) {
      const container = document.getElementById(`file-tags-container-${fileIndex}`);
      if (!container) return [];

      const tags = [];
      const rows = container.querySelectorAll('.file-tag-row');

      rows.forEach(row => {
        const nameInput = row.querySelector('.file-tag-name');
        const valueInput = row.querySelector('.file-tag-value');

        if (nameInput && valueInput && nameInput.value.trim() && valueInput.value.trim()) {
          tags.push({
            name: nameInput.value.trim(),
            value: valueInput.value.trim()
          });
        }
      });

      return tags;
    }

    // Check if we're on mobile
    function isMobileDevice() {
      return window.matchMedia('(max-width: 768px)').matches;
    }

    // Render detailed info panel for a file
    function renderFileDetails(index, uploadResult) {
      const panel = document.getElementById(`file-details-${index}`);
      const result = uploadResult.result;
      const paidUsdcAmount = uploadResult.paidUsdcAmount;

      if (!panel || !result) return;

      // Determine gateway host
      let gatewayHost = 'arweave.net';
      if (result.dataCaches && result.dataCaches.length > 0) {
        const currentHost = window.location.hostname;
        const matchingCache = result.dataCaches.find(cache => cache === currentHost);
        gatewayHost = matchingCache || result.dataCaches[0];
      }
      const txUrl = `https://${gatewayHost}/${result.id}`;

      // Use mobile-optimized layout on small screens
      if (isMobileDevice()) {
        let detailsHtml = `
          <div class="mobile-success-card">
            <div class="success-header">
              <span class="success-icon">‚úÖ</span>
              <span class="success-title">Upload Successful</span>
            </div>

            <div class="tx-id-section">
              <div class="tx-id-label">Transaction ID</div>
              <div class="tx-id-value">${result.id}</div>
            </div>

            <a href="${txUrl}" target="_blank" class="view-btn">
              <span>View on Arweave</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
            </a>

            <div class="details-grid">
        `;

        // Payment info - prominent on mobile
        if (paidUsdcAmount) {
          detailsHtml += `
            <div class="detail-box">
              <div class="detail-label">Payment</div>
              <div class="detail-value highlight">${paidUsdcAmount} USDC</div>
            </div>
          `;
        } else {
          detailsHtml += `
            <div class="detail-box">
              <div class="detail-label">Payment</div>
              <div class="detail-value" style="color: var(--turbo-blue);">Credits Used</div>
            </div>
          `;
        }

        // Storage cost
        if (result.receipt) {
          detailsHtml += `
            <div class="detail-box">
              <div class="detail-label">Storage Cost</div>
              <div class="detail-value">${result.receipt.winc} Winston</div>
            </div>
          `;
        }

        // Timestamp
        if (result.receipt && result.receipt.timestamp) {
          detailsHtml += `
            <div class="detail-box">
              <div class="detail-label">Timestamp</div>
              <div class="detail-value">${new Date(result.receipt.timestamp).toLocaleString()}</div>
            </div>
          `;
        }

        // Network info
        if (result.x402Payment && result.x402Payment.network) {
          detailsHtml += `
            <div class="detail-box">
              <div class="detail-label">Network</div>
              <div class="detail-value">${result.x402Payment.network}</div>
            </div>
          `;
        }

        // Owner - full width for long addresses
        if (result.owner) {
          detailsHtml += `
            <div class="detail-box full-width">
              <div class="detail-label">Owner</div>
              <div class="detail-value">${result.owner}</div>
            </div>
          `;
        }

        // Payer - full width for long addresses
        if (result.payer) {
          detailsHtml += `
            <div class="detail-box full-width">
              <div class="detail-label">Payer</div>
              <div class="detail-value">${result.payer}</div>
            </div>
          `;
        }

        detailsHtml += `
            </div>
          </div>
        `;

        panel.innerHTML = detailsHtml;
        return;
      }

      // Desktop layout (original grid-based layout)
      let detailsHtml = `
        <div class="file-detail-item file-detail-full">
          <span class="file-detail-label">Transaction ID:</span>
          <span class="file-detail-value">${result.id}</span>
          <a href="${txUrl}" target="_blank" class="file-detail-link">
            <span>View on Arweave</span>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </a>
        </div>
      `;

      if (result.owner) {
        detailsHtml += `
          <div class="file-detail-item">
            <span class="file-detail-label">Owner:</span>
            <span class="file-detail-value">${result.owner}</span>
          </div>
        `;
      }

      if (result.payer) {
        detailsHtml += `
          <div class="file-detail-item">
            <span class="file-detail-label">Payer:</span>
            <span class="file-detail-value">${result.payer}</span>
          </div>
        `;
      }

      if (result.receipt) {
        detailsHtml += `
          <div class="file-detail-item">
            <span class="file-detail-label">Storage Cost:</span>
            <span class="file-detail-value">${result.receipt.winc} Winston</span>
          </div>
          <div class="file-detail-item">
            <span class="file-detail-label">Timestamp:</span>
            <span class="file-detail-value">${new Date(result.receipt.timestamp).toLocaleString()}</span>
          </div>
        `;
      }

      if (paidUsdcAmount) {
        detailsHtml += `
          <div class="file-detail-item">
            <span class="file-detail-label">USDC Paid:</span>
            <span class="file-detail-value" style="color: var(--turbo-green); font-weight: 700;">${paidUsdcAmount} USDC</span>
          </div>
        `;
      }

      if (result.x402Payment) {
        if (result.x402Payment.network) {
          detailsHtml += `
            <div class="file-detail-item">
              <span class="file-detail-label">Payment Network:</span>
              <span class="file-detail-value">${result.x402Payment.network}</span>
            </div>
          `;
        }
        if (result.x402Payment.mode) {
          detailsHtml += `
            <div class="file-detail-item">
              <span class="file-detail-label">Payment Mode:</span>
              <span class="file-detail-value">${result.x402Payment.mode}</span>
            </div>
          `;
        }
      }

      panel.innerHTML = detailsHtml;
    }

    // Update file status during upload
    function updateFileStatus(index, status, uploadResult = null) {
      const statusIcon = document.getElementById(`file-status-${index}`);
      const paymentDiv = document.getElementById(`file-payment-${index}`);
      const toggleBtn = document.getElementById(`file-toggle-${index}`);
      const removeBtn = document.getElementById(`file-remove-${index}`);
      const tagsToggleBtn = document.getElementById(`file-tags-toggle-${index}`);
      const detailsPanel = document.getElementById(`file-details-${index}`);

      if (!statusIcon) return;

      statusIcon.className = `file-status-icon file-status-${status}`;

      switch (status) {
        case 'pending':
          statusIcon.textContent = '‚è≥';
          break;
        case 'uploading':
          statusIcon.textContent = 'üîÑ';
          break;
        case 'success':
          statusIcon.textContent = '‚úÖ';
          if (uploadResult) {
            // Show payment badge
            const paidUsdcAmount = uploadResult.paidUsdcAmount;
            paymentDiv.innerHTML = ''; // Clear existing content
            const badgeSpan = document.createElement('span');
            badgeSpan.className = paidUsdcAmount ? 'file-payment-badge payment-usdc' : 'file-payment-badge payment-credits';
            badgeSpan.textContent = paidUsdcAmount ? `üí≥ ${paidUsdcAmount} USDC` : 'üíé Credits';
            paymentDiv.appendChild(badgeSpan);

            // Show details toggle and hide tags/remove buttons
            toggleBtn.classList.remove('hidden');
            removeBtn.classList.add('hidden');
            if (tagsToggleBtn) tagsToggleBtn.classList.add('hidden');
            renderFileDetails(index, uploadResult);

            // Auto-expand details on mobile for better UX
            if (isMobileDevice() && detailsPanel) {
              detailsPanel.classList.add('expanded');
              toggleBtn.textContent = '‚ñ≤ Hide';
            }
          }
          break;
        case 'failed':
          statusIcon.textContent = '‚ùå';
          if (uploadResult && uploadResult.error) {
            paymentDiv.innerHTML = ''; // Clear existing content

            // Use mobile-friendly error card on mobile
            if (isMobileDevice()) {
              const errorCard = document.createElement('div');
              errorCard.className = 'mobile-error-card';
              errorCard.innerHTML = `
                <div class="error-header">
                  <span class="error-icon">‚ùå</span>
                  <span class="error-title">Upload Failed</span>
                </div>
                <div class="error-message">${uploadResult.error}</div>
              `;
              paymentDiv.appendChild(errorCard);
            } else {
              const errorSpan = document.createElement('span');
              errorSpan.className = 'file-error';
              errorSpan.textContent = `Error: ${uploadResult.error}`;
              errorSpan.setAttribute('title', uploadResult.error);
              paymentDiv.appendChild(errorSpan);
            }
          }
          removeBtn.classList.add('hidden');
          if (tagsToggleBtn) tagsToggleBtn.classList.add('hidden');
          break;
      }
    }

    // File input change handler with validation
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const newFiles = Array.from(e.target.files);

      if (newFiles.length === 0) return;

      // Validation
      let errors = [];

      if (newFiles.length > LIMITS.maxFiles) {
        errors.push(`Maximum ${LIMITS.maxFiles} files allowed`);
      }

      const oversizedFiles = newFiles.filter(f => f.size > LIMITS.maxFileSize);
      if (oversizedFiles.length > 0) {
        errors.push(`${oversizedFiles.length} file(s) exceed ${formatFileSize(LIMITS.maxFileSize)} limit`);
      }

      const totalSize = newFiles.reduce((sum, f) => sum + f.size, 0);
      if (totalSize > LIMITS.maxTotalSize) {
        errors.push(`Total size ${formatFileSize(totalSize)} exceeds ${formatFileSize(LIMITS.maxTotalSize)} limit`);
      }

      if (errors.length > 0) {
        log(`‚ùå Validation failed: ${errors.join(', ')}`, 'error');
        alert(`Cannot select files:\n\n${errors.join('\n')}`);
        e.target.value = ''; // Clear selection
        return;
      }

      selectedFiles = newFiles;
      log(`‚úÖ ${selectedFiles.length} file(s) selected (${formatFileSize(totalSize)})`, 'success');
      displayFileList();

      if (signer && selectedFiles.length > 0) {
        document.getElementById('uploadBtn').disabled = false;
      }
    });

    // MetaMask signer for arbundles (used in signed mode)
    class MetaMaskSigner {
      constructor(ethersSigner, address) {
        this.signer = ethersSigner;
        this.address = address;
        this.signatureType = 3;
        this.signatureLength = 65;
        this.ownerLength = 65;
        this.publicKey = null;
      }

      async setPublicKey() {
        if (!this.publicKey) {
          const message = 'Authorize x402 Arweave uploads for this session';
          const signature = await this.signer.signMessage(message);
          const messageHash = ethers.hashMessage(message);
          const recoveredPublicKey = ethers.SigningKey.recoverPublicKey(messageHash, signature);
          const publicKeyHex = recoveredPublicKey.slice(2);
          const bytes = new Uint8Array(publicKeyHex.length / 2);
          for (let i = 0; i < publicKeyHex.length; i += 2) {
            bytes[i / 2] = parseInt(publicKeyHex.substring(i, i + 2), 16);
          }
          this.publicKey = bytes;
          log(`‚úÖ Session authorized for data signing (public key: ${this.publicKey.length} bytes)`, 'success');
        }
      }

      async sign(message) {
        await this.setPublicKey();
        const signature = await this.signer.signMessage(message);
        return new Uint8Array(ethers.getBytes(signature));
      }
    }

    // Upload a single file with x402 payment support
    async function uploadSingleFile(file, fileIndex) {
      const uploadUrl = document.getElementById('uploadUrl').value;
      const prefix = `[${fileIndex + 1}/${selectedFiles.length}]`;

      try {
        // Read file
        log(`${prefix} Reading ${file.name}...`, 'info');
        const fileBuffer = await file.arrayBuffer();
        const fileData = new Uint8Array(fileBuffer);
        log(`${prefix} File read: ${fileData.length} bytes`, 'info');

        // Prepare data to upload
        let uploadData;
        let contentType;
        let customHeaders = {};

        if (currentMode === 'raw') {
          // RAW UPLOAD MODE
          log(`${prefix} Mode: Raw Upload`, 'info');
          uploadData = fileData;
          contentType = file.type || 'application/octet-stream';

          // Collect custom tags as headers from per-file tags
          const fileTags = getFileTags(fileIndex);
          fileTags.forEach(tag => {
            const headerName = `X-Tag-${tag.name.replace(/\s+/g, '-')}`;
            customHeaders[headerName] = tag.value;
          });
          if (fileTags.length > 0) {
            log(`${prefix} Added ${fileTags.length} custom tag(s)`, 'info');
          }
        } else {
          // SIGNED DATA ITEM MODE
          log(`${prefix} Mode: Signed Data Item`, 'info');
          log(`${prefix} Creating ANS-104 data item...`, 'info');

          const tags = [
            { name: 'Content-Type', value: file.type || 'application/octet-stream' },
            { name: 'File-Name', value: file.name }
          ];

          // Add custom tags from per-file tags
          const fileTags = getFileTags(fileIndex);
          fileTags.forEach(tag => {
            tags.push({ name: tag.name, value: tag.value });
          });
          if (fileTags.length > 0) {
            log(`${prefix} Added ${fileTags.length} custom tag(s)`, 'info');
          }

          const dataItem = window.arbundles.createData(fileData, dataSigner, { tags });
          log(`${prefix} Signing data item (approve in MetaMask)...`, 'info');
          await dataItem.sign(dataSigner);
          uploadData = dataItem.getRaw();
          contentType = 'application/octet-stream';
          log(`${prefix} Data item signed! ID: ${await dataItem.id}`, 'success');
        }

        // Use mode-specific x402 endpoints
        const uploadEndpoint = currentMode === 'raw'
          ? `${uploadUrl}/v1/x402/upload/unsigned`
          : `${uploadUrl}/v1/x402/upload/signed`;

        // Try upload first (with 5 minute timeout for large files)
        log(`${prefix} Attempting upload to ${uploadEndpoint}...`, 'info');
        const uploadTimeout = 300000; // 5 minutes
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), uploadTimeout);

        let uploadResponse;
        try {
          uploadResponse = await fetch(uploadEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': contentType,
              'Content-Length': uploadData.length.toString(),
              ...customHeaders,
            },
            body: uploadData,
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error(`Upload timed out after ${uploadTimeout / 1000} seconds`);
          }
          throw error;
        }

        let result;
        let paidUsdcAmount = null;

        // Handle success with existing credit balance (200 OK)
        if (uploadResponse.status === 200) {
          log(`${prefix} Upload succeeded using existing credits!`, 'success');
          result = await uploadResponse.json();
          paidUsdcAmount = null;
        }
        // Handle x402 payment required (402)
        else if (uploadResponse.status === 402) {
          log(`${prefix} 402 Payment Required - processing payment...`, 'warning');
          const priceData = await uploadResponse.json();

          // Create payment authorization
          const networkKey = document.getElementById('network').value;
          const config = NETWORK_CONFIG[networkKey];
          const requirements = priceData.accepts.find(a => a.network === networkKey);

          if (!requirements) {
            throw new Error(`Network ${networkKey} not available`);
          }

          const baseAmount = BigInt(requirements.maxAmountRequired);
          const amount = ethers.formatUnits(baseAmount, 6);
          paidUsdcAmount = amount;
          log(`${prefix} Payment required: ${amount} USDC`, 'warning');

          // Warn about Mini App limitations for signTypedData
          if (isMiniApp) {
            log(`${prefix} ‚ö†Ô∏è Mini App detected - signTypedData may not be supported`, 'warning');
            log(`${prefix} If payment fails, you'll need to pre-purchase credits via credit card`, 'info');
          }

          const currentTime = Math.floor(Date.now() / 1000);
          const validAfter = currentTime - 3600;
          const timeoutSeconds = requirements.maxTimeoutSeconds || 3600;
          const bufferSeconds = 120;
          const validBefore = currentTime + timeoutSeconds + bufferSeconds;

          const nonce = ethers.hexlify(ethers.randomBytes(32));

          const authorization = {
            from: userAddress,
            to: requirements.payTo,
            value: baseAmount.toString(),
            validAfter,
            validBefore,
            nonce,
          };

          const domain = {
            name: 'USD Coin',
            version: '2',
            chainId: config.chainId,
            verifyingContract: config.usdcAddress,
          };

          const types = {
            TransferWithAuthorization: [
              { name: 'from', type: 'address' },
              { name: 'to', type: 'address' },
              { name: 'value', type: 'uint256' },
              { name: 'validAfter', type: 'uint256' },
              { name: 'validBefore', type: 'uint256' },
              { name: 'nonce', type: 'bytes32' },
            ],
          };

          log(`${prefix} Signing payment authorization...`, 'warning');

          let signature;
          try {
            signature = await signer.signTypedData(domain, types, authorization);
            log(`${prefix} Payment authorized!`, 'success');
          } catch (signError) {
            // Handle signTypedData failure (common in Mini App)
            if (isMiniApp) {
              throw new Error(
                `Payment signing failed in Mini App. signTypedData is not yet supported. ` +
                `Please pre-purchase credits via credit card at turbo.ar.io first. ` +
                `Required: ${amount} USDC worth of credits.`
              );
            }
            throw signError;
          }

          const paymentPayload = {
            x402Version: 1,
            scheme: 'exact',
            network: networkKey,
            payload: { signature, authorization },
          };

          const paymentHeader = btoa(JSON.stringify(paymentPayload));

          // Retry upload with payment (with 5 minute timeout for large files)
          log(`${prefix} Retrying upload with payment to ${uploadEndpoint}...`, 'info');
          const retryController = new AbortController();
          const retryTimeoutId = setTimeout(() => retryController.abort(), uploadTimeout);

          try {
            uploadResponse = await fetch(uploadEndpoint, {
              method: 'POST',
              headers: {
                'Content-Type': contentType,
                'Content-Length': uploadData.length.toString(),
                'X-PAYMENT': paymentHeader,
                ...customHeaders,
              },
              body: uploadData,
              signal: retryController.signal
            });
            clearTimeout(retryTimeoutId);
          } catch (error) {
            clearTimeout(retryTimeoutId);
            if (error.name === 'AbortError') {
              throw new Error(`Upload with payment timed out after ${uploadTimeout / 1000} seconds`);
            }
            throw error;
          }

          if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            throw new Error(`Upload failed: ${uploadResponse.status} - ${errorText}`);
          }

          result = await uploadResponse.json();
        }
        // Handle unexpected status
        else {
          const errorText = await uploadResponse.text();
          throw new Error(`Unexpected response: ${uploadResponse.status} - ${errorText}`);
        }

        log(`${prefix} ‚úÖ Upload successful! ID: ${result.id}`, 'success');

        return {
          success: true,
          fileName: file.name,
          id: result.id,
          paidUsdcAmount,
          result
        };

      } catch (error) {
        log(`${prefix} ‚ùå Upload failed: ${error.message}`, 'error');
        return {
          success: false,
          fileName: file.name,
          error: error.message
        };
      }
    }

    // Upload all selected files sequentially
    async function uploadAllFiles() {
      if (selectedFiles.length === 0 || !signer) {
        log('Please connect wallet and select files', 'error');
        return;
      }

      // Warn about signature requirements
      if (selectedFiles.length > 1) {
        let warningMessage = `‚ö†Ô∏è IMPORTANT: Multi-File Upload Payment Model\n\n`;

        if (currentMode === 'signed') {
          const dataSignatures = selectedFiles.length;
          const paymentSignatures = selectedFiles.length;
          warningMessage += `This will require up to ${dataSignatures + paymentSignatures} MetaMask signatures:\n`;
          warningMessage += `‚Ä¢ ${dataSignatures} data item signatures (one per file)\n`;
          warningMessage += `‚Ä¢ ${paymentSignatures} payment signatures (one per file that needs payment)\n\n`;
        } else {
          warningMessage += `This will require up to ${selectedFiles.length} MetaMask payment signatures:\n`;
          warningMessage += `‚Ä¢ One payment signature per file that needs payment\n\n`;
        }

        warningMessage += `üí° TIP: If you have existing credits in your account, files will use those credits automatically (no payment signatures needed).\n\n`;
        warningMessage += `Continue with ${selectedFiles.length} file upload?`;

        if (!confirm(warningMessage)) {
          return;
        }
      }

      // Disable controls during upload
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('fileInput').disabled = true; // Prevent file selection during upload
      document.getElementById('cancelBtn').classList.remove('hidden');
      document.getElementById('uploadProgress').classList.remove('hidden');
      disableRemoveButtons(); // Prevent file removal during upload
      uploadResults = [];
      cancelUpload = false;

      log(`Starting batch upload of ${selectedFiles.length} file(s)...`, 'info');

      for (let i = 0; i < selectedFiles.length; i++) {
        if (cancelUpload) {
          log('‚ùå Batch upload cancelled by user', 'warning');
          break;
        }

        const file = selectedFiles[i];

        // Update progress
        const progressPercent = (i / selectedFiles.length) * 100;
        document.getElementById('progressBar').style.width = `${progressPercent}%`;
        document.getElementById('progressText').textContent = `Uploading file ${i + 1} of ${selectedFiles.length}: ${file.name}`;

        // Update file status to uploading
        updateFileStatus(i, 'uploading');

        // Upload file
        const result = await uploadSingleFile(file, i);
        uploadResults.push(result);

        // Update file status based on result
        if (result.success) {
          updateFileStatus(i, 'success', result);
        } else {
          updateFileStatus(i, 'failed', result);
        }
      }

      // Complete progress bar
      document.getElementById('progressBar').style.width = '100%';
      document.getElementById('progressText').textContent = 'Upload complete!';

      // Display batch results
      displayBatchResults();

      // Re-enable controls after upload
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('fileInput').disabled = false;
      document.getElementById('cancelBtn').classList.add('hidden');

      log(`Batch upload completed: ${uploadResults.filter(r => r.success).length}/${uploadResults.length} successful`, 'info');
    }

    // Display batch upload results
    function displayBatchResults() {
      const successCount = uploadResults.filter(r => r.success).length;
      const failedCount = uploadResults.filter(r => !r.success).length;

      const resultsHtml = `
        <div class="batch-results">
          <h3>üìä Upload Complete</h3>
          <div class="batch-summary">
            <div class="batch-summary-item">
              <span style="color: var(--turbo-green);">‚úÖ ${successCount} successful</span>
            </div>
            <div class="batch-summary-item">
              <span style="color: var(--turbo-red);">‚ùå ${failedCount} failed</span>
            </div>
            <div class="batch-summary-item">
              <span style="color: var(--link);">üì¶ ${uploadResults.length} total</span>
            </div>
          </div>
          <button onclick="resetBatchUpload()" class="btn-secondary">Upload More Files</button>
        </div>
      `;

      const resultsDiv = document.getElementById('uploadResults');
      resultsDiv.innerHTML = resultsHtml;
      resultsDiv.classList.remove('hidden');
      resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Reset for new batch upload
    function resetBatchUpload() {
      document.getElementById('uploadResults').classList.add('hidden');
      document.getElementById('uploadProgress').classList.add('hidden');
      document.getElementById('fileInput').value = '';
      document.getElementById('fileInput').disabled = false; // Ensure file input is enabled
      document.getElementById('fileInfo').innerHTML = '';
      document.getElementById('fileList').innerHTML = '';
      selectedFiles = [];
      uploadResults = [];
      fileTags = {}; // Clear all tags
      document.getElementById('uploadBtn').disabled = true;
      log('Ready for new upload', 'info');
    }

    // Cancel batch upload
    document.getElementById('cancelBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel the batch upload?')) {
        cancelUpload = true;
        log('Cancelling batch upload...', 'warning');
      }
    });

    // Main upload button handler
    document.getElementById('uploadBtn').addEventListener('click', async () => {
      await uploadAllFiles();
    });

    function resetUpload() {
      resetBatchUpload();
    }
  </script>
</body>
</html>
